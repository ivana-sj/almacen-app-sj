<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <title>Almacén Industrial - Sistema de Retiros Offline</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap');
        
        :root {
            --primary: #f59e0b;
            --primary-dark: #d97706;
        }
        
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
            min-height: 100vh;
            color: #e2e8f0;
            touch-action: manipulation;
            -webkit-tap-highlight-color: transparent;
        }
        
        .glass-panel {
            background: rgba(30, 41, 59, 0.7);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(148, 163, 184, 0.1);
        }
        
        #reader {
            width: 100% !important;
            border: none !important;
            background: #0f172a !important;
            min-height: 250px;
        }
        
        #reader video {
            border-radius: 12px !important;
            object-fit: cover !important;
            width: 100% !important;
            height: 100% !important;
        }
        
        .scanner-container {
            position: relative;
            overflow: hidden;
            border-radius: 12px;
            background: #0f172a;
            min-height: 300px;
        }
        
        .scanner-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            pointer-events: none;
            z-index: 10;
        }
        
        .scanner-frame {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 200px;
            height: 200px;
            border: 2px solid rgba(245, 158, 11, 0.5);
            border-radius: 12px;
        }
        
        .scanner-corner {
            position: absolute;
            width: 20px;
            height: 20px;
            border-color: #f59e0b;
            border-style: solid;
            border-width: 0;
        }
        
        .scanner-corner.top-left { top: -2px; left: -2px; border-top-width: 3px; border-left-width: 3px; }
        .scanner-corner.top-right { top: -2px; right: -2px; border-top-width: 3px; border-right-width: 3px; }
        .scanner-corner.bottom-left { bottom: -2px; left: -2px; border-bottom-width: 3px; border-left-width: 3px; }
        .scanner-corner.bottom-right { bottom: -2px; right: -2px; border-bottom-width: 3px; border-right-width: 3px; }
        
        .scanner-line {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 2px;
            background: linear-gradient(90deg, transparent, #f59e0b, transparent);
            animation: scan 2s linear infinite;
        }
        
        @keyframes scan {
            0% { top: 0; opacity: 0; }
            10% { opacity: 1; }
            90% { opacity: 1; }
            100% { top: 100%; opacity: 0; }
        }
        
        .connection-status {
            transition: all 0.3s ease;
        }
        
        .connection-status.offline {
            background: #dc2626;
            animation: pulse-red 2s infinite;
        }
        
        @keyframes pulse-red {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.6; }
        }
        
        .item-card {
            transition: all 0.2s ease;
        }
        
        .item-card:hover {
            transform: translateX(4px);
            border-left-color: var(--primary);
        }
        
        .legajo-input {
            font-size: 24px;
            letter-spacing: 4px;
            text-align: center;
            font-family: 'JetBrains Mono', monospace;
            font-weight: bold;
        }
        
        .numpad-btn {
            min-height: 56px;
            font-size: 20px;
            font-weight: 600;
            transition: all 0.1s;
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            user-select: none;
        }
        
        .numpad-btn:active {
            transform: scale(0.95);
            background: #f59e0b !important;
            color: #0f172a !important;
        }
        
        .slide-in {
            animation: slideIn 0.3s ease-out;
        }
        
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        .stock-alert {
            animation: shake 0.5s ease-in-out;
        }
        
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }
        
        .mono { font-family: 'JetBrains Mono', monospace; }
        
        .modal {
            transition: opacity 0.3s ease;
        }
        
        .modal.hidden {
            opacity: 0;
            pointer-events: none;
        }
        
        .modal:not(.hidden) {
            opacity: 1;
            pointer-events: auto;
        }
        
        ::-webkit-scrollbar {
            width: 6px;
        }
        ::-webkit-scrollbar-track {
            background: #1e293b;
        }
        ::-webkit-scrollbar-thumb {
            background: #475569;
            border-radius: 3px;
        }
        
        button:active {
            transform: scale(0.98);
        }
        
        .quantity-btn {
            min-width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .legajo-display {
            background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
            border: 2px solid #334155;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.3);
        }

        .pdf-action-btn {
            transition: all 0.2s;
        }
        
        .pdf-action-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }

        /* Camera error states */
        .camera-error {
            background: #1e293b;
            border: 2px dashed #475569;
        }

        .camera-permission-denied {
            background: #7f1d1d;
            border: 2px solid #ef4444;
        }
    </style>
</head>
<body class="antialiased overflow-x-hidden">

    <!-- App Container -->
    <div id="app" class="max-w-md mx-auto min-h-screen relative pb-20">
        
        <!-- Header -->
        <header class="glass-panel sticky top-0 z-40 px-4 py-3 border-b border-slate-700">
            <div class="flex items-center justify-between">
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 bg-gradient-to-br from-amber-500 to-orange-600 rounded-lg flex items-center justify-center shadow-lg">
                        <i class="fas fa-industry text-white text-lg"></i>
                    </div>
                    <div>
                        <h1 class="font-bold text-slate-100 text-sm tracking-wide">ALMACÉN CEMENTO</h1>
                        <p class="text-xs text-slate-400 mono" id="userDisplay">Sin autenticar</p>
                    </div>
                </div>
                <div class="flex items-center gap-2">
                    <div id="connectionStatus" class="connection-status online flex items-center gap-1 px-2 py-1 rounded-full bg-emerald-600/20 border border-emerald-500/30">
                        <div class="w-2 h-2 rounded-full bg-emerald-400 animate-pulse"></div>
                        <span class="text-xs font-medium text-emerald-400" id="connText">ONLINE</span>
                    </div>
                    <button onclick="toggleSync()" class="p-2 hover:bg-slate-700 rounded-lg transition-colors relative">
                        <i class="fas fa-sync-alt text-slate-300" id="syncIcon"></i>
                        <span id="pendingBadge" class="absolute -top-1 -right-1 w-5 h-5 bg-red-500 rounded-full text-xs flex items-center justify-center hidden font-bold text-white">0</span>
                    </button>
                </div>
            </div>
        </header>

        <!-- Main Content -->
        <main class="p-4 space-y-4">
            
            <!-- Scanner Section -->
            <section class="glass-panel rounded-2xl p-4 border border-slate-700">
                <div class="flex items-center justify-between mb-3">
                    <h2 class="text-sm font-semibold text-slate-200 uppercase tracking-wider">
                        <i class="fas fa-qrcode mr-2 text-amber-500"></i>Escanear Material
                    </h2>
                    <span class="text-xs text-slate-500 mono" id="scanMode">MODO CONTINUO</span>
                </div>
                
                <div class="scanner-container relative bg-slate-900 rounded-xl overflow-hidden" id="scannerContainer">
                    <!-- Video element for camera -->
                    <video id="cameraVideo" class="w-full h-full object-cover hidden" playsinline></video>
                    
                    <!-- html5-qrcode container -->
                    <div id="reader" class="w-full h-full"></div>
                    
                    <!-- Custom Overlay -->
                    <div class="scanner-overlay" id="scannerOverlay" style="display: none;">
                        <div class="scanner-frame">
                            <div class="scanner-corner top-left"></div>
                            <div class="scanner-corner top-right"></div>
                            <div class="scanner-corner bottom-left"></div>
                            <div class="scanner-corner bottom-right"></div>
                            <div class="scanner-line"></div>
                        </div>
                        <div class="absolute bottom-4 left-0 right-0 text-center">
                            <p class="text-amber-400 text-xs font-medium bg-slate-900/80 inline-block px-3 py-1 rounded-full">
                                <i class="fas fa-scan mr-1"></i>Enfoca el código QR
                            </p>
                        </div>
                    </div>
                    
                    <!-- Start Button -->
                    <div id="startScanBtn" class="absolute inset-0 flex items-center justify-center bg-slate-900/90 z-20">
                        <button onclick="requestCameraPermission()" class="bg-amber-500 hover:bg-amber-600 text-slate-900 px-6 py-3 rounded-xl font-bold shadow-lg flex items-center gap-2 transition-all">
                            <i class="fas fa-camera"></i>
                            <span>Iniciar Cámara</span>
                        </button>
                    </div>
                    
                    <!-- Error State -->
                    <div id="cameraError" class="absolute inset-0 flex flex-col items-center justify-center bg-slate-900/95 z-30 hidden">
                        <i class="fas fa-exclamation-circle text-red-400 text-4xl mb-3"></i>
                        <p class="text-slate-300 text-sm text-center px-4 mb-3">Error al acceder a la cámara</p>
                        <p class="text-slate-500 text-xs text-center px-4 mb-4" id="cameraErrorMsg">Verifique los permisos</p>
                        <div class="flex gap-2">
                            <button onclick="retryCamera()" class="bg-amber-500 hover:bg-amber-600 text-slate-900 px-4 py-2 rounded-lg text-sm font-bold">
                                <i class="fas fa-redo mr-1"></i>Reintentar
                            </button>
                            <button onclick="useFileInput()" class="bg-slate-700 hover:bg-slate-600 text-slate-200 px-4 py-2 rounded-lg text-sm">
                                <i class="fas fa-image mr-1"></i>Subir imagen
                            </button>
                        </div>
                    </div>
                    
                    <!-- Permission Denied State -->
                    <div id="permissionDenied" class="absolute inset-0 flex flex-col items-center justify-center bg-red-900/20 z-30 hidden border-2 border-red-500/50 rounded-xl">
                        <i class="fas fa-ban text-red-400 text-4xl mb-3"></i>
                        <p class="text-red-200 text-sm font-bold text-center px-4 mb-2">Permiso de cámara denegado</p>
                        <p class="text-red-300/70 text-xs text-center px-4 mb-4">Habilite el acceso a cámara en la configuración de su navegador</p>
                        <button onclick="showManualEntry()" class="bg-red-500/20 hover:bg-red-500/30 text-red-300 border border-red-500/50 px-4 py-2 rounded-lg text-sm">
                            Usar entrada manual
                        </button>
                    </div>
                </div>
                
                <div class="mt-3 flex gap-2">
                    <button onclick="toggleTorch()" class="flex-1 bg-slate-700 hover:bg-slate-600 py-2 rounded-lg text-xs font-medium transition-colors" id="torchBtn" style="display: none;">
                        <i class="fas fa-flashlight mr-1"></i>Linterna
                    </button>
                    <button onclick="toggleBatchMode()" class="flex-1 bg-slate-700 hover:bg-slate-600 py-2 rounded-lg text-xs font-medium transition-colors" id="batchBtn">
                        <i class="fas fa-layer-group mr-1"></i>Lote: OFF
                    </button>
                    <button onclick="stopScanner()" class="flex-1 bg-red-600/20 hover:bg-red-600/30 text-red-400 border border-red-500/30 py-2 rounded-lg text-xs font-medium transition-colors" id="stopBtn" style="display: none;">
                        <i class="fas fa-stop mr-1"></i>Detener
                    </button>
                </div>
                
                <!-- Manual Entry -->
                <div class="mt-3 pt-3 border-t border-slate-700" id="manualEntrySection">
                    <p class="text-xs text-slate-500 mb-2">Entrada manual (si el QR no lee):</p>
                    <div class="flex gap-2">
                        <input type="text" id="manualInput" placeholder="Ingrese SKU o Ubicación" 
                            class="flex-1 bg-slate-900 border border-slate-700 rounded-lg px-3 py-2 text-sm text-slate-200 focus:outline-none focus:border-amber-500 uppercase"
                            onkeypress="if(event.key==='Enter') manualScan()">
                        <button onclick="manualScan()" class="bg-slate-700 hover:bg-slate-600 text-slate-200 px-4 py-2 rounded-lg text-sm font-medium">
                            <i class="fas fa-arrow-right"></i>
                        </button>
                    </div>
                </div>
                
                <!-- File Input Fallback (hidden) -->
                <input type="file" id="fileInput" accept="image/*" capture="environment" class="hidden" onchange="handleFileSelect(event)">
            </section>

            <!-- Stock Validation Alert -->
            <div id="stockAlert" class="hidden bg-red-500/10 border border-red-500/30 rounded-xl p-4 slide-in">
                <div class="flex items-start gap-3">
                    <i class="fas fa-exclamation-triangle text-red-400 mt-1 text-lg"></i>
                    <div class="flex-1">
                        <h3 class="text-sm font-semibold text-red-300">Inconsistencia de Stock Detectada</h3>
                        <p class="text-xs text-slate-300 mt-1">El stock físico no coincide con el sistema.</p>
                        <div class="mt-3 flex gap-2">
                            <button onclick="openInconsistencyModal()" class="px-3 py-2 bg-red-500/20 hover:bg-red-500/30 text-red-300 rounded-lg text-xs font-medium border border-red-500/30 flex items-center gap-1">
                                <i class="fas fa-file-pdf"></i>
                                Generar Reporte PDF
                            </button>
                            <button onclick="dismissAlert()" class="px-3 py-2 text-slate-400 hover:text-slate-300 text-xs border border-slate-700 rounded-lg">
                                Ignorar
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Cart Section -->
            <section class="glass-panel rounded-2xl p-4 border border-slate-700">
                <div class="flex items-center justify-between mb-4">
                    <h2 class="text-sm font-semibold text-slate-200 uppercase tracking-wider">
                        <i class="fas fa-shopping-cart mr-2 text-amber-500"></i>Carrito de Retiro
                    </h2>
                    <span class="bg-slate-700 text-amber-400 px-2 py-1 rounded text-xs font-bold mono" id="itemCount">0 ítems</span>
                </div>

                <div id="cartItems" class="space-y-2 max-h-64 overflow-y-auto mb-4">
                    <div class="text-center py-8 text-slate-500">
                        <i class="fas fa-box-open text-3xl mb-2 opacity-50"></i>
                        <p class="text-sm">Escanea materiales para agregar</p>
                    </div>
                </div>

                <div class="border-t border-slate-700 pt-3 flex justify-between items-center">
                    <div>
                        <p class="text-xs text-slate-400">Total Estimado</p>
                        <p class="text-lg font-bold text-amber-400 mono" id="totalWeight">0.00 kg</p>
                    </div>
                    <button onclick="openLegajoModal()" id="checkoutBtn" disabled 
                        class="bg-gradient-to-r from-amber-500 to-orange-600 hover:from-amber-400 hover:to-orange-500 disabled:opacity-50 disabled:cursor-not-allowed text-slate-900 px-6 py-3 rounded-xl font-bold text-sm shadow-lg transition-all flex items-center gap-2">
                        <span>Finalizar</span>
                        <i class="fas fa-arrow-right"></i>
                    </button>
                </div>
            </section>

            <!-- Recent Activity -->
            <section class="glass-panel rounded-2xl p-4 border border-slate-700">
                <h2 class="text-sm font-semibold text-slate-200 uppercase tracking-wider mb-3">
                    <i class="fas fa-history mr-2 text-slate-400"></i>Actividad Reciente
                </h2>
                <div id="activityLog" class="space-y-2 text-xs">
                    <div class="flex items-center gap-3 text-slate-500 py-2 border-b border-slate-800/50">
                        <i class="fas fa-check-circle text-emerald-500"></i>
                        <span>Sistema iniciado - Listo para escanear</span>
                        <span class="ml-auto mono text-slate-600" id="currentTime">--:--</span>
                    </div>
                </div>
            </section>
        </main>

        <!-- Legajo Authentication Modal -->
        <div id="legajoModal" class="modal hidden fixed inset-0 bg-slate-900/95 z-50 flex items-center justify-center p-4 backdrop-blur-sm">
            <div class="bg-slate-800 rounded-2xl p-6 w-full max-w-sm border border-slate-700 shadow-2xl">
                <div class="flex items-center justify-between mb-6">
                    <div>
                        <h3 class="text-lg font-bold text-slate-100">Validar Retiro</h3>
                        <p class="text-xs text-slate-400 mt-1">Ingrese su número de legajo</p>
                    </div>
                    <button onclick="closeLegajoModal()" class="text-slate-400 hover:text-white p-2 hover:bg-slate-700 rounded-lg transition-colors">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                
                <div class="legajo-display rounded-xl p-4 mb-6 text-center">
                    <p class="text-xs text-slate-500 mb-1 uppercase tracking-wide">N° Legajo</p>
                    <input type="text" id="legajoInput" readonly 
                        class="legajo-input w-full bg-transparent border-none text-amber-400 text-center focus:outline-none" 
                        placeholder="____" maxlength="6">
                    <p class="text-xs text-slate-600 mt-2" id="legajoName">Ingrese 4-6 dígitos</p>
                </div>
                
                <div class="grid grid-cols-3 gap-2 mb-4">
                    <button onclick="appendDigit('1')" class="numpad-btn bg-slate-700 hover:bg-slate-600 text-slate-100 rounded-xl py-4">1</button>
                    <button onclick="appendDigit('2')" class="numpad-btn bg-slate-700 hover:bg-slate-600 text-slate-100 rounded-xl py-4">2</button>
                    <button onclick="appendDigit('3')" class="numpad-btn bg-slate-700 hover:bg-slate-600 text-slate-100 rounded-xl py-4">3</button>
                    <button onclick="appendDigit('4')" class="numpad-btn bg-slate-700 hover:bg-slate-600 text-slate-100 rounded-xl py-4">4</button>
                    <button onclick="appendDigit('5')" class="numpad-btn bg-slate-700 hover:bg-slate-600 text-slate-100 rounded-xl py-4">5</button>
                    <button onclick="appendDigit('6')" class="numpad-btn bg-slate-700 hover:bg-slate-600 text-slate-100 rounded-xl py-4">6</button>
                    <button onclick="appendDigit('7')" class="numpad-btn bg-slate-700 hover:bg-slate-600 text-slate-100 rounded-xl py-4">7</button>
                    <button onclick="appendDigit('8')" class="numpad-btn bg-slate-700 hover:bg-slate-600 text-slate-100 rounded-xl py-4">8</button>
                    <button onclick="appendDigit('9')" class="numpad-btn bg-slate-700 hover:bg-slate-600 text-slate-100 rounded-xl py-4">9</button>
                    <button onclick="clearLegajo()" class="numpad-btn bg-red-500/20 hover:bg-red-500/30 text-red-400 rounded-xl py-4 text-sm font-bold">
                        <i class="fas fa-trash-alt"></i>
                    </button>
                    <button onclick="appendDigit('0')" class="numpad-btn bg-slate-700 hover:bg-slate-600 text-slate-100 rounded-xl py-4">0</button>
                    <button onclick="backspaceDigit()" class="numpad-btn bg-slate-600 hover:bg-slate-500 text-slate-100 rounded-xl py-4">
                        <i class="fas fa-backspace"></i>
                    </button>
                </div>
                
                <button onclick="validateAndConfirm()" id="confirmLegajoBtn" disabled
                    class="w-full py-4 bg-amber-500 hover:bg-amber-600 disabled:opacity-50 disabled:cursor-not-allowed text-slate-900 rounded-xl font-bold text-lg shadow-lg shadow-amber-500/20 transition-all flex items-center justify-center gap-2">
                    <i class="fas fa-check-circle"></i>
                    <span>Confirmar Retiro</span>
                </button>
                
                <p class="text-center text-xs text-slate-500 mt-4">
                    <i class="fas fa-shield-alt mr-1"></i>
                    Este retiro quedará asociado a su legajo
                </p>
            </div>
        </div>

        <!-- Stock Inconsistency Modal -->
        <div id="inconsistencyModal" class="modal hidden fixed inset-0 bg-slate-900/95 z-50 flex items-center justify-center p-4 backdrop-blur-sm">
            <div class="bg-slate-800 rounded-2xl p-6 w-full max-w-sm border border-red-500/30 shadow-2xl">
                <div class="flex items-center gap-3 mb-4 text-red-400">
                    <div class="w-10 h-10 bg-red-500/20 rounded-full flex items-center justify-center">
                        <i class="fas fa-exclamation-triangle text-xl"></i>
                    </div>
                    <div>
                        <h3 class="text-lg font-bold">Reportar Inconsistencia</h3>
                        <p class="text-xs text-slate-400">Stock físico vs Sistema</p>
                    </div>
                </div>
                
                <div class="space-y-3 mb-4">
                    <div class="bg-slate-900/50 p-3 rounded-lg border border-slate-700">
                        <label class="text-xs text-slate-500 block mb-1">Material</label>
                        <p class="text-sm font-medium text-slate-200" id="incMaterial">--</p>
                        <p class="text-xs text-slate-500 mono" id="incUbicacion">--</p>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-3">
                        <div>
                            <label class="text-xs text-slate-400 block mb-1">Stock Teórico</label>
                            <input type="number" id="theoreticalStock" readonly 
                                class="w-full bg-slate-900 border border-slate-700 rounded-lg px-3 py-2 text-slate-400 mono text-sm text-center">
                        </div>
                        <div>
                            <label class="text-xs text-red-400 block mb-1">Stock Físico *</label>
                            <input type="number" id="physicalStock" placeholder="0" 
                                class="w-full bg-slate-900 border border-red-500/50 rounded-lg px-3 py-2 text-white mono text-sm text-center font-bold focus:outline-none focus:border-red-400">
                        </div>
                    </div>
                    
                    <div>
                        <label class="text-xs text-slate-400 block mb-1">Observación / Motivo</label>
                        <textarea id="incObservations" rows="3" placeholder="Describa la diferencia observada..." 
                            class="w-full bg-slate-900 border border-slate-700 rounded-lg px-3 py-2 text-slate-300 text-xs focus:outline-none focus:border-amber-500 resize-none"></textarea>
                    </div>
                </div>
                
                <div class="flex gap-2">
                    <button onclick="closeInconsistencyModal()" class="flex-1 py-3 border border-slate-600 text-slate-300 rounded-lg text-sm font-medium hover:bg-slate-700 transition-colors">
                        Cancelar
                    </button>
                    <button onclick="generateInconsistencyPDF()" class="flex-1 py-3 bg-red-500 hover:bg-red-600 text-white rounded-lg text-sm font-bold transition-colors shadow-lg shadow-red-500/20 flex items-center justify-center gap-2">
                        <i class="fas fa-file-pdf"></i>
                        Generar PDF
                    </button>
                </div>
            </div>
        </div>

        <!-- PDF Preview Modal -->
        <div id="pdfModal" class="modal hidden fixed inset-0 bg-slate-900/98 z-50 flex flex-col">
            <div class="flex items-center justify-between p-4 border-b border-slate-700 bg-slate-800">
                <div class="flex items-center gap-3">
                    <i class="fas fa-file-pdf text-red-400 text-xl"></i>
                    <div>
                        <h3 class="font-bold text-slate-100" id="pdfTitle">Documento Generado</h3>
                        <p class="text-xs text-slate-400" id="pdfSubtitle">Listo para descargar</p>
                    </div>
                </div>
                <button onclick="closePdfModal()" class="w-8 h-8 flex items-center justify-center rounded-full hover:bg-slate-700 text-slate-400 hover:text-white transition-colors">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="flex-1 overflow-auto p-4 bg-slate-900" id="pdfContainer"></div>
            <div class="p-4 border-t border-slate-700 bg-slate-800 space-y-2">
                <button onclick="downloadPDF()" class="w-full bg-emerald-600 hover:bg-emerald-700 text-white py-3 rounded-xl font-semibold text-sm transition-colors flex items-center justify-center gap-2 pdf-action-btn">
                    <i class="fas fa-download"></i>
                    Descargar PDF
                </button>
                <div class="grid grid-cols-2 gap-2">
                    <button onclick="shareViaEmail()" class="bg-blue-600 hover:bg-blue-700 text-white py-2 rounded-lg font-medium text-xs transition-colors flex items-center justify-center gap-1 pdf-action-btn">
                        <i class="fas fa-envelope"></i>
                        Enviar por Email
                    </button>
                    <button onclick="shareViaWhatsApp()" class="bg-green-600 hover:bg-green-700 text-white py-2 rounded-lg font-medium text-xs transition-colors flex items-center justify-center gap-1 pdf-action-btn">
                        <i class="fab fa-whatsapp"></i>
                        WhatsApp
                    </button>
                </div>
                <button onclick="closePdfModal()" class="w-full bg-slate-700 hover:bg-slate-600 text-slate-200 py-2 rounded-xl font-semibold text-sm transition-colors">
                    Cerrar
                </button>
            </div>
        </div>

    </div>

    <!-- Toast Notification -->
    <div id="toast" class="fixed bottom-4 left-4 right-4 bg-slate-800 border border-amber-500/30 text-slate-100 px-4 py-3 rounded-xl shadow-2xl transform translate-y-20 opacity-0 transition-all duration-300 z-50 flex items-center gap-3">
        <i class="fas fa-info-circle text-amber-500 text-lg"></i>
        <span class="text-sm font-medium" id="toastMessage">Notificación</span>
    </div>

    <script>
        // ===== DATA ARCHITECTURE =====
        const DataModel = {
            materials: [
                { id: 'MAT-001', sku: '12006762', description: 'ROD RIG BOLAS 6309-2RS1/3', ubicacion: 'A-01-05', stockTeorico: 120, um: 'BOL', pesoUnitario: 50 },
                { id: 'MAT-002', sku: 'AD-MICRO-01', description: 'Microsílice Aditivo Saco 25kg', ubicacion: 'A-02-12', stockTeorico: 45, um: 'SAC', pesoUnitario: 25 },
                { id: 'MAT-003', sku: 'CLIN-K-01', description: 'Clinker Tipo K Bulto', ubicacion: 'B-01-03', stockTeorico: 200, um: 'BUL', pesoUnitario: 1000 },
                { id: 'MAT-004', sku: 'YESO-IND-01', description: 'Yeso Industrial 40kg', ubicacion: 'A-03-08', stockTeorico: 80, um: 'BOL', pesoUnitario: 40 }
            ],
            workers: [
                { legajo: '1234', nombre: 'Juan Pérez', sector: 'Producción' },
                { legajo: '5678', nombre: 'María González', sector: 'Mantenimiento' },
                { legajo: '9012', nombre: 'Carlos Rodríguez', sector: 'Logística' },
                { legajo: '3456', nombre: 'Ana Martínez', sector: 'Calidad' }
            ],
            sessions: [],
            alerts: []
        };

        let appState = {
            currentSession: null,
            cart: [],
            isOffline: false,
            pendingSync: [],
            html5QrCode: null,
            isScanning: false,
            batchMode: false,
            currentScan: null,
            currentLegajo: '',
            currentWorker: null,
            currentPDFData: null,
            currentPDFType: null,
            currentSessionData: null,
            currentReportData: null,
            cameraPermission: false
        };

        // ===== INITIALIZATION =====
        document.addEventListener('DOMContentLoaded', () => {
            updateTime();
            setInterval(updateTime, 1000);
            checkConnection();
            setInterval(checkConnection, 5000);
            setInterval(attemptSync, 10000);
            loadDataLocal();
            
            // Check camera availability on load
            checkCameraAvailability();
        });

        function updateTime() {
            const now = new Date();
            document.getElementById('currentTime').textContent = 
                now.toLocaleTimeString('es-ES', { hour: '2-digit', minute: '2-digit' });
        }

        // ===== CAMERA PERMISSION & INITIALIZATION =====
        async function checkCameraAvailability() {
            try {
                if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                    showCameraError('Su dispositivo no soporta acceso a cámara');
                    return;
                }
                
                // Check if cameras are available
                const devices = await navigator.mediaDevices.enumerateDevices();
                const cameras = devices.filter(d => d.kind === 'videoinput');
                
                if (cameras.length === 0) {
                    showCameraError('No se detectaron cámaras en el dispositivo');
                }
            } catch (err) {
                console.error('Error checking cameras:', err);
            }
        }

        async function requestCameraPermission() {
            try {
                showToast('Solicitando acceso a cámara...', 'info');
                
                // First, request permission explicitly
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { 
                        facingMode: "environment",
                        width: { ideal: 1280 },
                        height: { ideal: 720 }
                    } 
                });
                
                // Permission granted, stop the stream (we'll restart it with html5-qrcode)
                stream.getTracks().forEach(track => track.stop());
                appState.cameraPermission = true;
                
                // Now start the scanner
                await startScanner();
                
            } catch (err) {
                console.error('Camera permission error:', err);
                handleCameraError(err);
            }
        }

        function handleCameraError(err) {
            const errorMsg = err.name || err.message || 'Error desconocido';
            
            if (err.name === 'NotAllowedError' || err.name === 'PermissionDeniedError') {
                document.getElementById('permissionDenied').classList.remove('hidden');
                document.getElementById('startScanBtn').classList.add('hidden');
            } else if (err.name === 'NotFoundError') {
                showCameraError('No se encontró cámara trasera. Use entrada manual.');
            } else if (err.name === 'NotReadableError') {
                showCameraError('La cámara está siendo usada por otra aplicación');
            } else {
                showCameraError(`Error: ${errorMsg}`);
            }
        }

        function showCameraError(msg) {
            document.getElementById('cameraErrorMsg').textContent = msg;
            document.getElementById('cameraError').classList.remove('hidden');
            document.getElementById('startScanBtn').classList.add('hidden');
        }

        function retryCamera() {
            document.getElementById('cameraError').classList.add('hidden');
            document.getElementById('startScanBtn').classList.remove('hidden');
            requestCameraPermission();
        }

        function showManualEntry() {
            document.getElementById('permissionDenied').classList.add('hidden');
            document.getElementById('manualEntrySection').scrollIntoView({ behavior: 'smooth' });
            document.getElementById('manualInput').focus();
            showToast('Use la entrada manual de código', 'info');
        }

        function useFileInput() {
            document.getElementById('fileInput').click();
        }

        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            showToast('Procesando imagen...', 'info');
            
            // Create a temporary html5-qrcode instance for file scanning
            const tempReader = new Html5Qrcode("temp-reader");
            
            tempReader.scanFile(file, true)
                .then(decodedText => {
                    processScan(decodedText);
                    showToast('Código detectado en imagen', 'success');
                })
                .catch(err => {
                    showToast('No se detectó código QR en la imagen', 'error');
                })
                .finally(() => {
                    // Clean up
                    document.getElementById('fileInput').value = '';
                });
        }

        // ===== QR SCANNER =====
        async function startScanner() {
            try {
                // Clean up any existing instance
                if (appState.html5QrCode) {
                    await appState.html5QrCode.stop().catch(() => {});
                }

                // Create new instance with explicit configuration for mobile
                appState.html5QrCode = new Html5Qrcode("reader", {
                    verbose: false,
                    useBarCodeDetectorIfSupported: true
                });
                
                const config = { 
                    fps: 10, 
                    qrbox: { width: 250, height: 250 },
                    aspectRatio: 1.0,
                    videoConstraints: {
                        facingMode: "environment",
                        width: { min: 640, ideal: 1280, max: 1920 },
                        height: { min: 480, ideal: 720, max: 1080 }
                    }
                };

                await appState.html5QrCode.start(
                    { facingMode: "environment" },
                    config,
                    onScanSuccess,
                    onScanFailure
                );

                appState.isScanning = true;
                document.getElementById('startScanBtn').classList.add('hidden');
                document.getElementById('cameraError').classList.add('hidden');
                document.getElementById('permissionDenied').classList.add('hidden');
                document.getElementById('scannerOverlay').style.display = 'block';
                document.getElementById('stopBtn').style.display = 'block';
                document.getElementById('torchBtn').style.display = 'block';
                
                showToast('Cámara activada - Enfoca el QR', 'success');
                addToActivityLog('Cámara iniciada correctamente', 'success');
                
            } catch (err) {
                console.error('Scanner start error:', err);
                handleCameraError(err);
            }
        }

        async function stopScanner() {
            if (appState.html5QrCode && appState.isScanning) {
                try {
                    await appState.html5QrCode.stop();
                } catch (e) {
                    console.error('Error stopping scanner:', e);
                }
                
                appState.isScanning = false;
                document.getElementById('startScanBtn').classList.remove('hidden');
                document.getElementById('scannerOverlay').style.display = 'none';
                document.getElementById('stopBtn').style.display = 'none';
                document.getElementById('torchBtn').style.display = 'none';
                
                addToActivityLog('Cámara detenida', 'info');
            }
        }

        function onScanSuccess(decodedText, decodedResult) {
            console.log('QR Detected:', decodedText);
            
            if (navigator.vibrate) navigator.vibrate(200);
            
            processScan(decodedText);
            
            if (!appState.batchMode) {
                stopScanner();
            }
        }

        function onScanFailure(error) {
            // Continuous scanning, ignore failures
        }

        function manualScan() {
            const input = document.getElementById('manualInput');
            const value = input.value.trim().toUpperCase();
            
            if (!value) {
                showToast('Ingrese un código válido', 'error');
                return;
            }
            
            processScan(value);
            input.value = '';
            input.focus();
        }

        // ===== OFFLINE LOGIC =====
        function checkConnection() {
            const isOnline = navigator.onLine;
            const statusEl = document.getElementById('connectionStatus');
            const statusText = document.getElementById('connText');
            
            if (!isOnline && !appState.isOffline) {
                appState.isOffline = true;
                statusEl.classList.remove('online');
                statusEl.classList.add('offline');
                statusText.textContent = 'OFFLINE';
                statusText.classList.remove('text-emerald-400');
                statusText.classList.add('text-red-400');
                statusEl.querySelector('div').classList.remove('bg-emerald-400');
                statusEl.querySelector('div').classList.add('bg-red-400');
                showToast('Modo Offline activado', 'warning');
                saveDataLocal();
            } else if (isOnline && appState.isOffline) {
                appState.isOffline = false;
                statusEl.classList.remove('offline');
                statusEl.classList.add('online');
                statusText.textContent = 'ONLINE';
                statusText.classList.remove('text-red-400');
                statusText.classList.add('text-emerald-400');
                statusEl.querySelector('div').classList.remove('bg-red-400');
                statusEl.querySelector('div').classList.add('bg-emerald-400');
                showToast('Conexión restablecida', 'success');
                attemptSync();
            }
        }

        function saveDataLocal() {
            const data = { 
                cart: appState.cart, 
                pendingSync: appState.pendingSync, 
                timestamp: new Date().toISOString() 
            };
            localStorage.setItem('almacen_offline_data', JSON.stringify(data));
            updatePendingBadge();
        }

        function loadDataLocal() {
            const saved = localStorage.getItem('almacen_offline_data');
            if (saved) {
                const data = JSON.parse(saved);
                appState.cart = data.cart || [];
                appState.pendingSync = data.pendingSync || [];
                renderCart();
                updatePendingBadge();
            }
        }

        function updatePendingBadge() {
            const badge = document.getElementById('pendingBadge');
            const count = appState.pendingSync.length;
            if (count > 0) {
                badge.textContent = count;
                badge.classList.remove('hidden');
            } else {
                badge.classList.add('hidden');
            }
        }

        async function attemptSync() {
            if (!navigator.onLine || appState.pendingSync.length === 0) return;
            
            showToast(`Sincronizando ${appState.pendingSync.length} registros...`, 'info');
            
            for (let item of [...appState.pendingSync]) {
                try {
                    await syncToCloud(item);
                    appState.pendingSync = appState.pendingSync.filter(i => i.id !== item.id);
                } catch (err) {
                    console.error('Sync failed:', err);
                }
            }
            
            saveDataLocal();
            updatePendingBadge();
            
            if (appState.pendingSync.length === 0) {
                showToast('Sincronización completada', 'success');
            }
        }

        function toggleSync() {
            if (appState.pendingSync.length > 0) {
                attemptSync();
            } else {
                showToast('No hay datos pendientes', 'info');
            }
        }

        // ===== SCAN PROCESSING =====
        function processScan(qrData) {
            const material = DataModel.materials.find(m => 
                m.ubicacion.toUpperCase() === qrData.toUpperCase() || 
                m.sku.toUpperCase() === qrData.toUpperCase() ||
                m.id.toUpperCase() === qrData.toUpperCase()
            );
            
            if (!material) {
                showToast(`Código "${qrData}" no encontrado`, 'error');
                return;
            }
            
            appState.currentScan = material;
            showStockValidation(material);
            
            if (appState.batchMode) {
                setTimeout(() => addToCart(material, 1), 300);
            }
        }

        function showStockValidation(material) {
            const alertDiv = document.getElementById('stockAlert');
            document.getElementById('theoreticalStock').value = material.stockTeorico;
            document.getElementById('incMaterial').textContent = material.description;
            document.getElementById('incUbicacion').textContent = material.ubicacion;
            
            alertDiv.classList.remove('hidden');
            alertDiv.classList.add('stock-alert');
            
            const existingBtn = alertDiv.querySelector('.add-to-cart-btn');
            if (existingBtn) existingBtn.remove();
            
            const addBtn = document.createElement('button');
            addBtn.className = 'add-to-cart-btn mt-3 w-full py-2 bg-amber-500/20 hover:bg-amber-500/30 text-amber-400 rounded-lg text-xs font-medium border border-amber-500/30';
            addBtn.innerHTML = '<i class="fas fa-plus mr-1"></i> Agregar al carrito de todos modos';
            addBtn.onclick = () => { addToCart(material, 1); dismissAlert(); };
            alertDiv.querySelector('.flex-1').appendChild(addBtn);
        }

        function dismissAlert() {
            document.getElementById('stockAlert').classList.add('hidden');
        }

        // ===== CART MANAGEMENT =====
        function addToCart(material, qty) {
            const existing = appState.cart.find(item => item.materialId === material.id);
            
            if (existing) {
                existing.cantidad += qty;
                existing.subtotal = existing.cantidad * material.pesoUnitario;
            } else {
                appState.cart.push({
                    id: Date.now().toString() + Math.random().toString(36).substr(2, 9),
                    materialId: material.id,
                    sku: material.sku,
                    description: material.description,
                    ubicacion: material.ubicacion,
                    cantidad: qty,
                    um: material.um,
                    pesoUnitario: material.pesoUnitario,
                    subtotal: qty * material.pesoUnitario,
                    timestamp: new Date().toISOString()
                });
            }
            
            renderCart();
            saveDataLocal();
            showToast(`${material.sku} agregado (${qty} ${material.um})`, 'success');
            
            if (navigator.vibrate) navigator.vibrate([50, 100, 50]);
        }

        function removeFromCart(id) {
            appState.cart = appState.cart.filter(item => item.id !== id);
            renderCart();
            saveDataLocal();
        }

        function updateQuantity(id, delta) {
            const item = appState.cart.find(i => i.id === id);
            if (!item) return;
            
            const newQty = item.cantidad + delta;
            if (newQty < 1) {
                removeFromCart(id);
                return;
            }
            
            item.cantidad = newQty;
            item.subtotal = item.cantidad * item.pesoUnitario;
            renderCart();
            saveDataLocal();
        }

        function renderCart() {
            const container = document.getElementById('cartItems');
            const countEl = document.getElementById('itemCount');
            const totalEl = document.getElementById('totalWeight');
            const checkoutBtn = document.getElementById('checkoutBtn');
            
            countEl.textContent = `${appState.cart.length} ítems`;
            
            if (appState.cart.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-8 text-slate-500">
                        <i class="fas fa-box-open text-3xl mb-2 opacity-50"></i>
                        <p class="text-sm">Escanea materiales para agregar</p>
                    </div>`;
                totalEl.textContent = '0.00 kg';
                checkoutBtn.disabled = true;
                return;
            }
            
            let totalWeight = 0;
            
            container.innerHTML = appState.cart.map(item => {
                totalWeight += item.subtotal;
                return `
                    <div class="item-card bg-slate-800/50 border-l-4 border-slate-600 rounded-r-lg p-3 flex items-center justify-between">
                        <div class="flex-1 min-w-0">
                            <div class="flex items-center gap-2 mb-1">
                                <span class="text-xs font-bold text-amber-400 mono">${item.sku}</span>
                                <span class="text-[10px] text-slate-500 bg-slate-800 px-1.5 rounded border border-slate-700">${item.ubicacion}</span>
                            </div>
                            <p class="text-xs text-slate-300 truncate mb-2">${item.description}</p>
                            <div class="flex items-center gap-2">
                                <div class="flex items-center bg-slate-900 rounded-lg border border-slate-700">
                                    <button onclick="updateQuantity('${item.id}', -1)" class="quantity-btn text-slate-400 hover:text-white active:bg-slate-700 rounded-l-lg">
                                        <i class="fas fa-minus text-xs"></i>
                                    </button>
                                    <span class="px-3 text-xs font-mono text-amber-400 font-bold">${item.cantidad}</span>
                                    <button onclick="updateQuantity('${item.id}', 1)" class="quantity-btn text-slate-400 hover:text-white active:bg-slate-700 rounded-r-lg">
                                        <i class="fas fa-plus text-xs"></i>
                                    </button>
                                </div>
                                <span class="text-xs text-slate-500 mono">${item.subtotal} kg</span>
                            </div>
                        </div>
                        <button onclick="removeFromCart('${item.id}')" class="ml-3 p-2 text-slate-600 hover:text-red-400 transition-colors rounded-lg hover:bg-slate-800">
                            <i class="fas fa-trash-alt"></i>
                        </button>
                    </div>`;
            }).join('');
            
            totalEl.textContent = `${totalWeight.toFixed(2)} kg`;
            checkoutBtn.disabled = false;
        }

        // ===== STOCK INCONSISTENCY =====
        function openInconsistencyModal() {
            document.getElementById('inconsistencyModal').classList.remove('hidden');
            if (appState.currentScan) {
                setTimeout(() => document.getElementById('physicalStock').focus(), 100);
            }
        }

        function closeInconsistencyModal() {
            document.getElementById('inconsistencyModal').classList.add('hidden');
            document.getElementById('physicalStock').value = '';
            document.getElementById('incObservations').value = '';
        }

        function generateInconsistencyPDF() {
            const physical = document.getElementById('physicalStock').value;
            const obs = document.getElementById('incObservations').value;
            const material = appState.currentScan;
            
            if (!physical || physical === '') {
                showToast('Ingrese el stock físico real', 'error');
                document.getElementById('physicalStock').focus();
                return;
            }
            
            if (!material) {
                showToast('Error: No hay material seleccionado', 'error');
                return;
            }
            
            const diferencia = parseInt(physical) - material.stockTeorico;
            const tipoDiferencia = diferencia > 0 ? 'SOBRANTE' : 'FALTANTE';
            
            const incReport = {
                id: `INC-${Date.now()}`,
                tipo: 'INCONSISTENCIA_STOCK',
                materialId: material.id,
                sku: material.sku,
                description: material.description,
                ubicacion: material.ubicacion,
                stockTeorico: material.stockTeorico,
                stockFisico: parseInt(physical),
                diferencia: diferencia,
                tipoDiferencia: tipoDiferencia,
                observaciones: obs,
                fecha: new Date().toLocaleDateString('es-ES'),
                hora: new Date().toLocaleTimeString('es-ES'),
                reportadoPor: appState.currentWorker ? `${appState.currentWorker.nombre} (${appState.currentLegajo})` : 'Sistema',
                estado: 'PENDIENTE_REVISIÓN'
            };
            
            DataModel.alerts.push(incReport);
            appState.currentReportData = incReport;
            
            createInconsistencyPDF(incReport);
            closeInconsistencyModal();
            dismissAlert();
            addToActivityLog(`Reporte inconsistencia: ${material.sku} (${tipoDiferencia} ${Math.abs(diferencia)})`, 'warning');
        }

        function createInconsistencyPDF(report) {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            // Header
            doc.setFillColor(220, 38, 38);
            doc.rect(0, 0, 210, 40, 'F');
            doc.setTextColor(255, 255, 255);
            doc.setFontSize(18);
            doc.text('REPORTE DE INCONSISTENCIA DE STOCK', 105, 20, { align: 'center' });
            doc.setFontSize(12);
            doc.text('ALMACÉN CEMENTOS INDUSTRIALES', 105, 30, { align: 'center' });
            
            // Alert Box
            doc.setFillColor(254, 226, 226);
            doc.rect(20, 48, 170, 25, 'F');
            doc.setDrawColor(220, 38, 38);
            doc.rect(20, 48, 170, 25, 'S');
            doc.setTextColor(153, 27, 27);
            doc.setFontSize(10);
            doc.setFont(undefined, 'bold');
            doc.text(`DIFERENCIA DETECTADA: ${report.tipoDiferencia}`, 25, 58);
            doc.setFont(undefined, 'normal');
            doc.setFontSize(9);
            doc.text(`Diferencia de ${Math.abs(report.diferencia)} unidades requiere revisión`, 25, 65);
            
            // Info
            doc.setTextColor(60, 60, 60);
            doc.setFontSize(10);
            doc.text('INFORMACIÓN DEL REPORTE', 20, 85);
            
            doc.setFontSize(9);
            doc.setTextColor(100, 100, 100);
            doc.text(`N° Reporte:`, 20, 95);
            doc.setTextColor(0, 0, 0);
            doc.setFont(undefined, 'bold');
            doc.text(report.id, 60, 95);
            
            doc.setFont(undefined, 'normal');
            doc.setTextColor(100, 100, 100);
            doc.text(`Fecha/Hora:`, 20, 102);
            doc.setTextColor(0, 0, 0);
            doc.text(`${report.fecha} ${report.hora}`, 60, 102);
            
            doc.setTextColor(100, 100, 100);
            doc.text(`Reportado por:`, 20, 109);
            doc.setTextColor(0, 0, 0);
            doc.text(report.reportadoPor, 60, 109);
            
            // Material Details
            doc.setFillColor(248, 250, 252);
            doc.rect(20, 118, 170, 50, 'F');
            doc.setDrawColor(203, 213, 225);
            doc.rect(20, 118, 170, 50, 'S');
            
            doc.setFontSize(10);
            doc.setTextColor(30, 41, 59);
            doc.setFont(undefined, 'bold');
            doc.text('DETALLES DEL MATERIAL', 25, 128);
            
            doc.setFont(undefined, 'normal');
            doc.setFontSize(9);
            doc.setTextColor(100, 100, 100);
            doc.text('SKU:', 25, 138);
            doc.setTextColor(0, 0, 0);
            doc.setFont(undefined, 'bold');
            doc.text(report.sku, 70, 138);
            
            doc.setFont(undefined, 'normal');
            doc.setTextColor(100, 100, 100);
            doc.text('Descripción:', 25, 145);
            doc.setTextColor(0, 0, 0);
            doc.text(report.description, 70, 145);
            
            doc.setTextColor(100, 100, 100);
            doc.text('Ubicación:', 25, 152);
            doc.setTextColor(0, 0, 0);
            doc.text(report.ubicacion, 70, 152);
            
            // Stock Table
            doc.setFillColor(30, 41, 59);
            doc.rect(20, 175, 170, 10, 'F');
            doc.setTextColor(255, 255, 255);
            doc.setFontSize(8);
            doc.text('TIPO', 25, 181);
            doc.text('CANTIDAD', 80, 181);
            doc.text('DIFERENCIA', 130, 181);
            
            doc.setTextColor(0, 0, 0);
            doc.setFontSize(9);
            
            doc.setFillColor(241, 245, 249);
            doc.rect(20, 185, 170, 12, 'F');
            doc.text('Stock Teórico (Sistema)', 25, 192);
            doc.setFont(undefined, 'bold');
            doc.text(report.stockTeorico.toString(), 85, 192);
            doc.setFont(undefined, 'normal');
            doc.text('-', 140, 192);
            
            doc.setFillColor(255, 255, 255);
            doc.rect(20, 197, 170, 12, 'F');
            doc.text('Stock Físico (Conteo)', 25, 204);
            doc.setFont(undefined, 'bold');
            doc.text(report.stockFisico.toString(), 85, 204);
            doc.setTextColor(220, 38, 38);
            doc.text(`${report.diferencia > 0 ? '+' : ''}${report.diferencia}`, 140, 204);
            
            doc.setFillColor(254, 226, 226);
            doc.rect(20, 209, 170, 12, 'F');
            doc.setTextColor(153, 27, 27);
            doc.setFont(undefined, 'bold');
            doc.text('RESULTADO', 25, 216);
            doc.text(report.tipoDiferencia, 85, 216);
            doc.text(Math.abs(report.diferencia).toString(), 140, 216);
            
            // Observations
            doc.setTextColor(60, 60, 60);
            doc.setFontSize(10);
            doc.setFont(undefined, 'bold');
            doc.text('OBSERVACIONES:', 20, 235);
            
            doc.setFont(undefined, 'normal');
            doc.setFontSize(9);
            doc.setTextColor(80, 80, 80);
            const splitObs = doc.splitTextToSize(report.observaciones || 'Sin observaciones adicionales', 170);
            doc.text(splitObs, 20, 242);
            
            // Footer
            doc.setFontSize(8);
            doc.setTextColor(150, 150, 150);
            doc.text('Documento generado para revisión de almacén y control de inventario', 105, 280, { align: 'center' });
            doc.text(`Hash: ${btoa(report.id).substring(0, 24)} | Estado: ${report.estado}`, 105, 285, { align: 'center' });
            
            appState.currentPDFData = doc.output('datauristring');
            appState.currentPDFType = 'inconsistencia';
            
            showInconsistencyPDFPreview(report);
        }

        function showInconsistencyPDFPreview(report) {
            const modal = document.getElementById('pdfModal');
            const container = document.getElementById('pdfContainer');
            
            document.getElementById('pdfTitle').textContent = 'Reporte de Inconsistencia';
            document.getElementById('pdfSubtitle').textContent = `${report.sku} - Listo para enviar`;
            
            container.innerHTML = `
                <div class="bg-white p-6 rounded-lg shadow-2xl max-w-2xl mx-auto">
                    <div class="border-b-4 border-red-500 pb-4 mb-6 bg-red-50 -m-6 p-6 rounded-t-lg">
                        <div class="flex items-center justify-center gap-3">
                            <i class="fas fa-exclamation-triangle text-red-500 text-2xl"></i>
                            <div>
                                <h1 class="text-xl font-bold text-gray-800 text-center">REPORTE DE INCONSISTENCIA</h1>
                                <p class="text-center text-red-600 mt-1 text-sm font-semibold">${report.tipoDiferencia}: ${Math.abs(report.diferencia)} unidades</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="bg-red-50 border-l-4 border-red-500 p-4 mb-6">
                        <p class="text-sm text-red-800">
                            <i class="fas fa-info-circle mr-1"></i>
                            Este documento requiere revisión inmediata por parte del supervisor de almacén.
                        </p>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-4 mb-6 text-sm">
                        <div class="bg-gray-50 p-3 rounded-lg">
                            <p class="text-gray-500 text-xs uppercase tracking-wide">N° Reporte</p>
                            <p class="font-mono font-bold text-gray-800">${report.id}</p>
                            <p class="text-gray-500 text-xs uppercase tracking-wide mt-2">Fecha/Hora</p>
                            <p class="font-semibold text-gray-800">${report.fecha} ${report.hora}</p>
                        </div>
                        <div class="bg-gray-50 p-3 rounded-lg text-right">
                            <p class="text-gray-500 text-xs uppercase tracking-wide">Reportado por</p>
                            <p class="font-semibold text-gray-800">${report.reportadoPor}</p>
                            <p class="text-gray-500 text-xs uppercase tracking-wide mt-2">Estado</p>
                            <span class="inline-block bg-red-100 text-red-800 text-xs px-2 py-1 rounded-full font-bold">PENDIENTE</span>
                        </div>
                    </div>
                    
                    <div class="bg-slate-100 p-4 rounded-lg mb-6">
                        <h3 class="font-bold text-slate-800 mb-3 text-sm uppercase tracking-wide">Detalles del Material</h3>
                        <div class="grid grid-cols-2 gap-4 text-sm">
                            <div>
                                <p class="text-gray-500 text-xs">SKU</p>
                                <p class="font-mono font-bold text-amber-600">${report.sku}</p>
                            </div>
                            <div>
                                <p class="text-gray-500 text-xs">Ubicación</p>
                                <p class="font-semibold text-gray-800">${report.ubicacion}</p>
                            </div>
                            <div class="col-span-2">
                                <p class="text-gray-500 text-xs">Descripción</p>
                                <p class="text-gray-800">${report.description}</p>
                            </div>
                        </div>
                    </div>
                    
                    <table class="w-full text-sm mb-6 border-collapse">
                        <thead class="bg-slate-800 text-white">
                            <tr>
                                <th class="p-3 text-left text-xs uppercase">Tipo</th>
                                <th class="p-3 text-center text-xs uppercase">Cantidad</th>
                                <th class="p-3 text-right text-xs uppercase">Diferencia</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-gray-200">
                            <tr class="bg-gray-50">
                                <td class="p-3 text-gray-700">Stock Teórico (Sistema)</td>
                                <td class="p-3 text-center font-bold">${report.stockTeorico}</td>
                                <td class="p-3 text-right">-</td>
                            </tr>
                            <tr>
                                <td class="p-3 text-gray-700">Stock Físico (Conteo)</td>
                                <td class="p-3 text-center font-bold">${report.stockFisico}</td>
                                <td class="p-3 text-right font-bold text-red-600">${report.diferencia > 0 ? '+' : ''}${report.diferencia}</td>
                            </tr>
                            <tr class="bg-red-50 border-t-2 border-red-200">
                                <td class="p-3 font-bold text-red-800">RESULTADO</td>
                                <td class="p-3 text-center font-bold text-red-800">${report.tipoDiferencia}</td>
                                <td class="p-3 text-right font-bold text-red-800">${Math.abs(report.diferencia)}</td>
                            </tr>
                        </tbody>
                    </table>
                    
                    <div class="bg-gray-50 p-4 rounded-lg border border-gray-200">
                        <p class="text-xs text-gray-500 uppercase tracking-wide font-semibold mb-2">Observaciones</p>
                        <p class="text-sm text-gray-700">${report.observaciones || 'Sin observaciones adicionales'}</p>
                    </div>
                    
                    <div class="mt-6 text-center text-xs text-gray-400 border-t border-gray-200 pt-4">
                        <p>Documento generado para revisión de almacén y control de inventario</p>
                        <p class="mono mt-1 text-[10px]">Hash: ${btoa(report.id).substring(0, 24)}</p>
                    </div>
                </div>
            `;
            
            modal.classList.remove('hidden');
        }

        // ===== LEGAJO AUTHENTICATION =====
        function openLegajoModal() {
            if (appState.cart.length === 0) {
                showToast('El carrito está vacío', 'error');
                return;
            }
            
            appState.currentLegajo = '';
            appState.currentWorker = null;
            updateLegajoDisplay();
            document.getElementById('legajoModal').classList.remove('hidden');
        }

        function closeLegajoModal() {
            document.getElementById('legajoModal').classList.add('hidden');
            appState.currentLegajo = '';
            appState.currentWorker = null;
        }

        function appendDigit(digit) {
            if (appState.currentLegajo.length >= 6) return;
            appState.currentLegajo += digit;
            updateLegajoDisplay();
            validateLegajo();
        }

        function backspaceDigit() {
            appState.currentLegajo = appState.currentLegajo.slice(0, -1);
            updateLegajoDisplay();
            validateLegajo();
        }

        function clearLegajo() {
            appState.currentLegajo = '';
            appState.currentWorker = null;
            updateLegajoDisplay();
            validateLegajo();
        }

        function updateLegajoDisplay() {
            const input = document.getElementById('legajoInput');
            const nameDisplay = document.getElementById('legajoName');
            
            let formatted = appState.currentLegajo;
            if (formatted.length > 2) {
                formatted = formatted.slice(0, 2) + '-' + formatted.slice(2);
            }
            input.value = formatted;
            
            const worker = DataModel.workers.find(w => w.legajo === appState.currentLegajo);
            if (worker) {
                appState.currentWorker = worker;
                nameDisplay.textContent = `${worker.nombre} - ${worker.sector}`;
                nameDisplay.className = 'text-xs text-emerald-400 mt-2 font-semibold';
            } else {
                appState.currentWorker = null;
                if (appState.currentLegajo.length >= 4) {
                    nameDisplay.textContent = 'Legajo no encontrado';
                    nameDisplay.className = 'text-xs text-red-400 mt-2';
                } else {
                    nameDisplay.textContent = 'Ingrese 4-6 dígitos';
                    nameDisplay.className = 'text-xs text-slate-600 mt-2';
                }
            }
        }

        function validateLegajo() {
            const btn = document.getElementById('confirmLegajoBtn');
            btn.disabled = !(appState.currentWorker && appState.currentLegajo.length >= 4);
        }

        function validateAndConfirm() {
            if (!appState.currentWorker) {
                showToast('Legajo no válido', 'error');
                return;
            }
            
            document.getElementById('userDisplay').textContent = 
                `${appState.currentWorker.nombre} (${appState.currentLegajo})`;
            
            const session = {
                id: `RET-${Date.now()}`,
                fecha: new Date().toLocaleDateString('es-ES'),
                hora: new Date().toLocaleTimeString('es-ES'),
                legajo: appState.currentLegajo,
                operario: appState.currentWorker.nombre,
                sector: appState.currentWorker.sector,
                items: [...appState.cart],
                totalPeso: appState.cart.reduce((sum, item) => sum + item.subtotal, 0),
                estado: appState.isOffline ? 'PENDIENTE_SYNC' : 'COMPLETADO'
            };
            
            appState.currentSessionData = session;
            DataModel.sessions.push(session);
            
            if (appState.isOffline) {
                appState.pendingSync.push(session);
                saveDataLocal();
            }
            
            generateRetiroPDF(session);
            closeLegajoModal();
            
            appState.cart = [];
            renderCart();
            saveDataLocal();
            
            if (!appState.isOffline) triggerEmailWorkflow(session);
            
            addToActivityLog(`Retiro ${session.id} por ${appState.currentWorker.nombre}`, 'success');
            showToast('Retiro procesado correctamente', 'success');
        }

        // ===== RETIRO PDF =====
        function generateRetiroPDF(session) {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            // Header
            doc.setFillColor(245, 158, 11);
            doc.rect(0, 0, 210, 35, 'F');
            doc.setTextColor(255, 255, 255);
            doc.setFontSize(20);
            doc.text('VALE DE CONSUMO', 105, 22, { align: 'center' });
            
            // Info
            doc.setTextColor(60, 60, 60);
            doc.setFontSize(10);
            doc.text('CEMENTOS INDUSTRIALES S.A.', 20, 45);
            
            doc.setFontSize(9);
            doc.text(`Documento: ${session.id}`, 20, 55);
            doc.text(`Fecha/Hora: ${session.fecha} ${session.hora}`, 20, 60);
            doc.text(`Legajo: ${session.legajo}`, 20, 65);
            doc.text(`Operario: ${session.operario}`, 20, 70);
            doc.text(`Sector: ${session.sector}`, 20, 75);
            
            // Table Header
            doc.setFillColor(30, 41, 59);
            doc.rect(20, 82, 170, 8, 'F');
            doc.setTextColor(255, 255, 255);
            doc.setFontSize(8);
            doc.text('SKU', 25, 87);
            doc.text('DESCRIPCIÓN', 65, 87);
            doc.text('UBIC.', 120, 87);
            doc.text('CANT.', 140, 87);
            doc.text('PESO', 165, 87);
            
            // Items
            let y = 96;
            doc.setTextColor(50, 50, 50);
            session.items.forEach(item => {
                if (y > 250) {
                    doc.addPage();
                    y = 20;
                }
                doc.setFontSize(8);
                doc.text(item.sku, 25, y);
                doc.setFontSize(7);
                doc.text(item.description.substring(0, 35), 65, y);
                doc.setFontSize(8);
                doc.text(item.ubicacion, 122, y);
                doc.text(item.cantidad.toString() + ' ' + item.um, 142, y);
                doc.text(item.subtotal.toFixed(1) + ' kg', 165, y);
                y += 6;
            });
            
            // Total
            y += 5;
            doc.setDrawColor(200, 200, 200);
            doc.line(20, y, 190, y);
            doc.setFontSize(11);
            doc.setTextColor(245, 158, 11);
            doc.setFont(undefined, 'bold');
            doc.text(`PESO TOTAL: ${session.totalPeso.toFixed(2)} kg`, 190, y + 10, { align: 'right' });
            
            // Legajo validation
            y += 25;
            doc.setTextColor(80, 80, 80);
            doc.setFontSize(9);
            doc.setFont(undefined, 'normal');
            doc.text('Validación por Número de Legajo:', 20, y);
            doc.setFontSize(10);
            doc.setFont(undefined, 'bold');
            doc.text(`Legajo: ${session.legajo}`, 20, y + 8);
            doc.setFont(undefined, 'normal');
            doc.text(`Nombre: ${session.operario}`, 20, y + 14);
            doc.text(`Sector: ${session.sector}`, 20, y + 20);
            
            doc.setFontSize(8);
            doc.text('El operario declara haber retirado los materiales listados arriba', 20, y + 30);
            doc.text('y asume responsabilidad sobre su uso y destino.', 20, y + 34);
            
            // Footer
            doc.setFontSize(7);
            doc.setTextColor(150, 150, 150);
            doc.text('Documento generado digitalmente - Sistema Almacén Offline-First v2.0', 105, 285, { align: 'center' });
            doc.text(`Hash: ${btoa(session.id).substring(0, 20)}`, 105, 289, { align: 'center' });
            
            appState.currentPDFData = doc.output('datauristring');
            appState.currentPDFType = 'retiro';
            
            showRetiroPDFPreview(session);
        }

        function showRetiroPDFPreview(session) {
            const modal = document.getElementById('pdfModal');
            const container = document.getElementById('pdfContainer');
            
            document.getElementById('pdfTitle').textContent = 'Vale de Consumo Generado';
            document.getElementById('pdfSubtitle').textContent = 'Listo para descargar o compartir';
            
            container.innerHTML = `
                <div class="bg-white p-6 rounded-lg shadow-2xl max-w-2xl mx-auto">
                    <div class="border-b-4 border-amber-500 pb-4 mb-6 bg-amber-50 -m-6 p-6 rounded-t-lg">
                        <h1 class="text-2xl font-bold text-gray-800 text-center">VALE DE CONSUMO</h1>
                        <p class="text-center text-gray-600 mt-1 text-sm">CEMENTOS INDUSTRIALES S.A.</p>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-4 mb-6 text-sm bg-gray-50 p-4 rounded-lg">
                        <div>
                            <p class="text-gray-600 text-xs uppercase tracking-wide">Documento</p>
                            <p class="font-mono font-bold text-gray-800">${session.id}</p>
                            <p class="text-gray-600 text-xs uppercase tracking-wide mt-2">Fecha/Hora</p>
                            <p class="font-semibold text-gray-800">${session.fecha} ${session.hora}</p>
                        </div>
                        <div class="text-right">
                            <p class="text-gray-600 text-xs uppercase tracking-wide">Operario</p>
                            <p class="font-semibold text-gray-800">${session.operario}</p>
                            <p class="text-gray-500 text-xs">Legajo: ${session.legajo}</p>
                            <p class="text-amber-600 font-bold text-xl mt-2">${session.totalPeso.toFixed(2)} kg</p>
                        </div>
                    </div>
                    
                    <table class="w-full text-sm mb-6 border-collapse">
                        <thead class="bg-slate-800 text-white">
                            <tr>
                                <th class="p-3 text-left text-xs uppercase">SKU</th>
                                <th class="p-3 text-left text-xs uppercase">Descripción</th>
                                <th class="p-3 text-center text-xs uppercase">Cant.</th>
                                <th class="p-3 text-right text-xs uppercase">Peso</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-gray-200">
                            ${session.items.map(item => `
                                <tr class="border-b border-gray-100 hover:bg-gray-50">
                                    <td class="p-3 font-mono text-xs font-bold text-amber-600">${item.sku}</td>
                                    <td class="p-3 text-gray-700">${item.description}</td>
                                    <td class="p-3 text-center font-bold">${item.cantidad} <span class="text-xs text-gray-500">${item.um}</span></td>
                                    <td class="p-3 text-right mono text-gray-600">${item.subtotal.toFixed(1)} kg</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                    
                    <div class="mt-8 pt-6 border-t-2 border-gray-200 bg-gray-50 p-4 rounded-lg">
                        <div class="flex items-center gap-3 mb-2">
                            <i class="fas fa-id-card text-amber-500 text-xl"></i>
                            <div>
                                <p class="text-xs text-gray-500 uppercase tracking-wide font-semibold">Validación por Legajo</p>
                                <p class="text-sm font-bold text-gray-800">${session.operario} <span class="text-gray-500 font-normal">(${session.legajo})</span></p>
                                <p class="text-xs text-gray-500">Sector: ${session.sector}</p>
                            </div>
                        </div>
                        <p class="text-xs text-gray-500 mt-2">
                            El operario declara haber retirado los materiales listados y asume responsabilidad sobre su uso y destino.
                        </p>
                    </div>
                    
                    <div class="mt-8 text-center text-xs text-gray-400 border-t border-gray-200 pt-4">
                        <p>Documento generado digitalmente - Sistema Almacén Offline-First v2.0</p>
                        <p class="mono mt-1 text-[10px]">Hash: ${btoa(session.id).substring(0, 24)}</p>
                    </div>
                </div>
            `;
            
            modal.classList.remove('hidden');
        }

        // ===== PDF ACTIONS =====
        function closePdfModal() {
            document.getElementById('pdfModal').classList.add('hidden');
            appState.currentPDFData = null;
            appState.currentPDFType = null;
        }

        function downloadPDF() {
            if (!appState.currentPDFData) return;
            
            const link = document.createElement('a');
            link.href = appState.currentPDFData;
            
            const prefix = appState.currentPDFType === 'inconsistencia' ? 'Reporte_Inconsistencia' : 'Vale_Consumo';
            const id = appState.currentPDFType === 'inconsistencia' 
                ? appState.currentReportData.id 
                : (appState.currentSessionData ? appState.currentSessionData.id : Date.now());
            
            link.download = `${prefix}_${id}.pdf`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            showToast('PDF descargado correctamente', 'success');
        }

        function shareViaEmail() {
            if (!appState.currentPDFData) return;
            
            let subject, body;
            
            if (appState.currentPDFType === 'inconsistencia') {
                subject = 'URGENTE: Reporte de Inconsistencia de Stock - Almacén';
                body = `Se adjunta reporte de inconsistencia de stock detectada en almacén.\n\nMaterial: ${appState.currentReportData.sku}\nDiferencia: ${appState.currentReportData.diferencia} unidades\n\nRequiere revisión inmediata.`;
            } else {
                const session = appState.currentSessionData;
                if (!session) return;
                
                const itemsList = session.items.map(item => 
                    `- ${item.sku}: ${item.cantidad} ${item.um} (${item.subtotal} kg)`
                ).join('\n');
                
                const totalCantidad = session.items.reduce((sum, item) => sum + item.cantidad, 0);
                
                subject = `Vale de Consumo - ${session.id} - Legajo ${session.legajo}`;
                body = `Vale de Consumo generado en Almacén\n\n` +
                       `📋 Documento: ${session.id}\n` +
                       `👤 Legajo: ${session.legajo}\n` +
                       `👨‍🏭 Operario: ${session.operario}\n` +
                       `🏭 Sector: ${session.sector}\n` +
                       `📅 Fecha: ${session.fecha} ${session.hora}\n\n` +
                       `ARTÍCULOS RETIRADOS (${session.items.length} ítems, ${totalCantidad} unidades):\n${itemsList}\n\n` +
                       `⚖️ Total Peso: ${session.totalPeso.toFixed(2)} kg\n` +
                       `✅ Estado: COMPLETADO\n\n` +
                       `Por favor procesar en sistema ERP.`;
            }
            
            if (navigator.share && navigator.canShare && appState.currentPDFType !== 'inconsistencia') {
                fetch(appState.currentPDFData)
                    .then(res => res.blob())
                    .then(blob => {
                        const file = new File([blob], `Vale_${appState.currentSessionData.id}.pdf`, { type: 'application/pdf' });
                        if (navigator.canShare({ files: [file] })) {
                            navigator.share({
                                title: subject,
                                text: body,
                                files: [file]
                            }).catch(err => console.log('Share canceled'));
                        } else {
                            fallbackEmail(subject, body);
                        }
                    });
            } else {
                fallbackEmail(subject, body);
            }
        }

        function fallbackEmail(subject, body) {
            const mailtoLink = `mailto:?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
            window.location.href = mailtoLink;
            showToast('Abriendo cliente de correo...', 'info');
        }

        function shareViaWhatsApp() {
            let text = '';
            
            if (appState.currentPDFType === 'inconsistencia') {
                text = `*URGENTE:* Reporte de Inconsistencia de Stock generado\nMaterial: ${appState.currentReportData.sku}\nDiferencia: ${appState.currentReportData.diferencia} unidades\nEstado: PENDIENTE REVISIÓN`;
            } else {
                const session = appState.currentSessionData;
                if (!session) return;
                
                const itemsList = session.items.map(item => 
                    `• ${item.sku}: ${item.cantidad} ${item.um}`
                ).join('\n');
                
                const totalCantidad = session.items.reduce((sum, item) => sum + item.cantidad, 0);
                
                text = `*VALE DE CONSUMO - ALMACÉN CEMENTOS*\n\n` +
                       `📋 *Documento:* ${session.id}\n` +
                       `👤 *Legajo:* ${session.legajo}\n` +
                       `👨‍🏭 *Operario:* ${session.operario}\n\n` +
                       `*ARTÍCULOS RETIRADOS (${session.items.length} ítems):*\n` +
                       `${itemsList}\n\n` +
                       `📊 *Total Cantidad:* ${totalCantidad} unidades\n` +
                       `⚖️ *Total Peso:* ${session.totalPeso.toFixed(2)} kg\n` +
                       `✅ *Estado:* COMPLETADO`;
            }
            
            const whatsappUrl = `https://wa.me/?text=${encodeURIComponent(text)}`;
            window.open(whatsappUrl, '_blank');
        }

        // ===== WORKFLOWS =====
        async function triggerEmailWorkflow(session) {
            console.log('Enviando notificaciones...', session);
            showToast('Notificaciones enviadas', 'success');
        }

        async function syncToCloud(session) {
            return new Promise((resolve) => setTimeout(() => resolve({ success: true }), 800));
        }

        // ===== UTILITIES =====
        function toggleBatchMode() {
            appState.batchMode = !appState.batchMode;
            const btn = document.getElementById('batchBtn');
            if (appState.batchMode) {
                btn.classList.add('bg-amber-600', 'text-white');
                btn.classList.remove('bg-slate-700');
                btn.innerHTML = '<i class="fas fa-layer-group mr-1"></i>Lote: ON';
                showToast('Modo lote activado', 'info');
            } else {
                btn.classList.remove('bg-amber-600', 'text-white');
                btn.classList.add('bg-slate-700');
                btn.innerHTML = '<i class="fas fa-layer-group mr-1"></i>Lote: OFF';
            }
        }

        function toggleTorch() {
            showToast('Función no disponible en este dispositivo', 'info');
        }

        function addToActivityLog(message, type = 'info') {
            const log = document.getElementById('activityLog');
            const time = new Date().toLocaleTimeString('es-ES', { hour: '2-digit', minute: '2-digit' });
            const colors = { success: 'text-emerald-400', warning: 'text-amber-400', error: 'text-red-400', info: 'text-blue-400' };
            const icons = { success: 'fa-check-circle', warning: 'fa-exclamation-triangle', error: 'fa-times-circle', info: 'fa-info-circle' };
            
            const entry = document.createElement('div');
            entry.className = 'flex items-center gap-3 py-2 border-b border-slate-800/50';
            entry.innerHTML = `
                <i class="fas ${icons[type]} ${colors[type]} text-xs"></i>
                <span class="text-slate-300 flex-1 text-xs">${message}</span>
                <span class="mono text-slate-600 text-xs">${time}</span>
            `;
            log.insertBefore(entry, log.firstChild);
            while (log.children.length > 10) log.removeChild(log.lastChild);
        }

        function showToast(message, type = 'info') {
            const toast = document.getElementById('toast');
            const msg = document.getElementById('toastMessage');
            msg.textContent = message;
            
            const config = {
                success: { border: 'border-emerald-500/30', icon: 'fa-check-circle', color: 'text-emerald-400' },
                warning: { border: 'border-amber-500/30', icon: 'fa-exclamation-triangle', color: 'text-amber-400' },
                error: { border: 'border-red-500/30', icon: 'fa-times-circle', color: 'text-red-400' },
                info: { border: 'border-blue-500/30', icon: 'fa-info-circle', color: 'text-blue-400' }
            };
            
            const c = config[type];
            toast.className = `fixed bottom-4 left-4 right-4 bg-slate-800 border ${c.border} text-slate-100 px-4 py-3 rounded-xl shadow-2xl transform transition-all duration-300 z-50 flex items-center gap-3`;
            toast.querySelector('i').className = `fas ${c.icon} ${c.color} text-lg`;
            
            requestAnimationFrame(() => toast.classList.remove('translate-y-20', 'opacity-0'));
            setTimeout(() => toast.classList.add('translate-y-20', 'opacity-0'), 3000);
        }

        window.onclick = function(event) {
            ['legajoModal', 'inconsistencyModal', 'pdfModal'].forEach(id => {
                const modal = document.getElementById(id);
                if (event.target === modal && id !== 'pdfModal') {
                    modal.classList.add('hidden');
                }
            });
        }
    </script>
</body>
</html>